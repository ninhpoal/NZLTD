<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phiếu Xuất Nhập Kho</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uuid/8.3.2/uuid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <style>
     body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        h1,
        h2 {
            color: #2c3e50;
            text-align: center;
        }

        form {
            background: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          
            margin: 0 auto;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }

        input,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 16px;
            box-sizing: border-box;
        }

        button {
            background: #3498db;
            color: #fff;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s ease;
        }

        button:hover {
            background: #2980b9;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: #fff;
        }

        th,
        td {
            border: 1px solid #bdc3c7;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #3498db;
            color: #fff;
        }

        .table-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .remove-cable {
            background: #e74c3c;
        }

        .remove-cable:hover {
            background: #c0392b;
        }

        .search-select {
            position: relative;
        }

        .search-select .options {
            display: none;
            position: absolute;
            background-color: #fff;
            min-width: 100%;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            z-index: 1;
            max-height: 200px;
            overflow-y: auto;
            border-radius: 0 0 4px 4px;
        }

        .search-select .options div {
            padding: 10px;
            cursor: pointer;
        }

        .search-select .options div:hover {
            background-color: #ecf0f1;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
   

    <form id="xuatNhapForm">
        <div class="loading" id="loadingIndicator">
            <div class="spinner"></div>
            <p>Đang xử lý...</p>
        </div>
        <h2>Thông tin Xuất Nhập Cáp</h2>
        <div class="form-row">
            <div class="form-group">
                <label for="maKeHoach">Mã kế hoạch:</label>
                <div class="search-select">
                    <input type="text" id="maKeHoach" required>
                    <div class="options" id="maKeHoachOptions"></div>
                </div>
            </div>
            <div class="form-group">
                <label for="muc">Mục:</label>
                <select id="muc" required>
                    <option value="">Chọn mục</option>
                    <option value="Xuất thi công">Xuất thi công</option>
                    <option value="Nhập kho NZ">Nhập kho NZ</option>
                    <option value="Nhập kho FPT">Nhập kho FPT</option>
                </select>
            </div>
            <div class="form-group">
                <label for="tu">Từ:</label>
                <select id="tu" required></select>
            </div>
            <div class="form-group">
                <label for="den">Đến:</label>
                <select id="den" required></select>
            </div>
        </div>

        <h2>Chi tiết XN CÁP</h2>
        <table id="cableTable">
            <thead>
                <tr>
                    <th>Loại cáp</th>
                    <th>Số đầu</th>
                    <th>Số cuối</th>
                    <th>Chủng loại</th>
                    <th>Mã cáp</th>
                    <th>Năm sản xuất</th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody id="cableList"></tbody>
        </table>

        <button type="button" id="addCable">Thêm Cáp</button>
        <button type="submit">Tạo Phiếu</button>
    </form>

    <div id="result"></div>
    <div id="debug"></div>

    <script>
        const APP_ID = '3519f9a9-390d-425c-b2af-4c76794ddd4a';
        const TABLE_NAME_XN_CAP = 'Xuất nhập cáp';
        const TABLE_NAME_CHI_TIET = 'Chi tiết XN CÁP';
        const TABLE_NAME_DU_AN = 'Dự án FPT';
        const TABLE_NAME_NHAN_VIEN = 'Nhân viên';
        const API_KEY = 'V2-DxCTd-Nhf75-B243D-CQXD9-1ePO4-GCtq5-mHU1v-YHx0j';
        const API_BASE_URL = 'https://www.appsheet.com/api/v2/apps';

        let cableCount = 0;
        let maKeHoachList = [];
        let nhanVienList = [];
        const loaiCapList = ["08FO", "12FO", "16FO", "24FO", "48FO", "96FO", "144FO", "04DU", "12DU", "16DU", "24DU", "48DU", "96DU", "144DU"];

        // Initialize toastr
        toastr.options = {
            "closeButton": true,
            "debug": false,
            "newestOnTop": false,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "preventDuplicates": false,
            "onclick": null,
            "showDuration": "300",
            "hideDuration": "1000",
            "timeOut": "5000",
            "extendedTimeOut": "1000",
            "showEasing": "swing",
            "hideEasing": "linear",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        }

        function apiRequest(tableName, action, data) {
            const apiUrl = `${API_BASE_URL}/${APP_ID}/tables/${encodeURIComponent(tableName)}/Action`;
            return $.ajax({
                url: apiUrl,
                method: 'POST',
                headers: {
                    'ApplicationAccessKey': API_KEY,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    Action: action,
                    Properties: {
                        Locale: 'vi-VN',
                        Timezone: 'Asia/Ho_Chi_Minh'
                    },
                    ...data
                })
            });
        }

        async function loadMaKeHoach() {
            try {
                const result = await apiRequest(TABLE_NAME_DU_AN, 'Find', {
                    Selector: "Filter(Dự án FPT, true)"
                });

                console.log('loadMaKeHoach result:', result);

                if (result && Array.isArray(result)) {
                    maKeHoachList = result.map(row => row['MDA']).filter(Boolean);
                    updateMaKeHoachOptions();
                } else {
                    throw new Error('Không nhận được dữ liệu mã kế hoạch hợp lệ từ API');
                }
            } catch (error) {
                console.error('Lỗi khi tải mã kế hoạch:', error);
                $('#debug').append(`<p>Lỗi khi tải mã kế hoạch: ${error.message}</p>`);
                toastr.error('Không thể tải mã kế hoạch. Vui lòng thử lại sau.', 'Lỗi');
            }
        }

        function updateMaKeHoachOptions() {
            const options = $('#maKeHoachOptions');
            options.empty();
            maKeHoachList.forEach(maKeHoach => {
                options.append(`<div>${maKeHoach}</div>`);
            });
        }

        $('#maKeHoach').on('input', function () {
            const filter = $(this).val().toUpperCase();
            const options = $('#maKeHoachOptions');
            options.show();
            options.find('div').each(function () {
                const txtValue = $(this).text();
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        $(document).on('click', '#maKeHoachOptions div', function () {
            $('#maKeHoach').val($(this).text());
            $('#maKeHoachOptions').hide();
        });

        async function loadNhanVien() {
            try {
                const result = await apiRequest(TABLE_NAME_NHAN_VIEN, 'Find', {
                    Selector: "Filter(Nhân viên, [Phòng ban]='Đội thi công')"
                });

                console.log('loadNhanVien result:', result);

                if (result && Array.isArray(result)) {
                    nhanVienList = result.map(row => row['Mã nhân viên']).filter(Boolean);
                } else {
                    throw new Error('Không nhận được dữ liệu nhân viên hợp lệ từ API');
                }
            } catch (error) {
                console.error('Lỗi khi tải nhân viên:', error);
                $('#debug').append(`<p>Lỗi khi tải nhân viên: ${error.message}</p>`);
                toastr.error('Không thể tải danh sách nhân viên. Vui lòng thử lại sau.', 'Lỗi');
            }
        }

        function updateTuDenOptions() {
            const muc = $('#muc').val();
            const tuSelect = $('#tu');
            const denSelect = $('#den');

            tuSelect.empty();
            denSelect.empty();

            if (muc === 'Xuất thi công') {
                tuSelect.append('<option value="Kho NZ">Kho NZ</option>');
                nhanVienList.forEach(nv => {
                    denSelect.append(`<option value="${nv}">${nv}</option>`);
                });
            } else if (muc === 'Nhập kho NZ') {
                nhanVienList.forEach(nv => {
                    tuSelect.append(`<option value="${nv}">${nv}</option>`);
                });
                tuSelect.append('<option value="Kho FPT">Kho FPT</option>');
                denSelect.append('<option value="Kho NZ">Kho NZ</option>');
            } else if (muc === 'Nhập kho FPT') {
                tuSelect.append('<option value="Kho NZ">Kho NZ</option>');
                denSelect.append('<option value="Kho FPT">Kho FPT</option>');
            }
        }

        $('#muc').on('change', updateTuDenOptions);

        function addCableForm() {
            cableCount++;
            const newRow = $('<tr>');
            newRow.html(`
                <td>
                    <select id="loaiCap${cableCount}" class="table-input" required>
                        ${loaiCapList.map(cap => `<option value="${cap}">${cap}</option>`).join('')}
                        <option value="other">Khác</option>
                    </select>
                    <input type="text" id="loaiCapOther${cableCount}" class="table-input" style="display:none;" placeholder="Nhập loại cáp khác">
                </td>
                <td><input type="number" id="soDau${cableCount}" class="table-input" required></td>
                <td><input type="number" id="soCuoi${cableCount}" class="table-input" required></td>
                <td><input type="text" id="chungLoai${cableCount}" class="table-input" required></td>
                <td><input type="text" id="maCap${cableCount}" class="table-input" required></td>
                <td><input type="number" id="namSanXuat${cableCount}" class="table-input" required></td>
                <td><button type="button" class="remove-cable">Xóa</button></td>
            `);
            $('#cableList').append(newRow);

            newRow.find('.remove-cable').on('click', function () {
                newRow.remove();
            });

            newRow.find(`#loaiCap${cableCount}`).on('change', function () {
                const otherInput = newRow.find(`#loaiCapOther${cableCount}`);
                if (this.value === 'other') {
                    otherInput.show().prop('required', true);
                } else {
                    otherInput.hide().prop('required', false);
                }
            });
        }

        $('#addCable').on('click', addCableForm);

        $('#xuatNhapForm').on('submit', async function (e) {
            e.preventDefault();

            $('#loadingIndicator').show();

            try {
                const idXnCap = uuid.v4();

                const xuatNhapCap = {
                    ID_XN_CAP: idXnCap,
                    "Mã kế hoạch": $('#maKeHoach').val(),
                    "Mục": $('#muc').val(),
                    "Từ": $('#tu').val(),
                    "Đến": $('#den').val()
                };
                console.log(xuatNhapCap)
                const chiTietXnCapList = [];
                $('#cableList tr').each(function (index) {
                    const loaiCapSelect = $(this).find(`#loaiCap${index + 1}`);
                    const loaiCapOther = $(this).find(`#loaiCapOther${index + 1}`);
                    const loaiCap = loaiCapSelect.val() === 'other' ? loaiCapOther.val() : loaiCapSelect.val();

                    chiTietXnCapList.push({
                        ID_D_CAP: uuid.v4(),
                        ID_XN_CAP: idXnCap,
                        "Loại cáp": loaiCap,
                        "Số đầu": $(this).find(`#soDau${index + 1}`).val(),
                        "Số cuối": $(this).find(`#soCuoi${index + 1}`).val(),
                        "Chủng loại": $(this).find(`#chungLoai${index + 1}`).val(),
                        "Mã cáp": $(this).find(`#maCap${index + 1}`).val(),
                        "Năm sản xuất": String($(this).find(`#namSanXuat${index + 1}`).val())
                    });
                });

                console.log('Sending Xuat nhap cap data:', xuatNhapCap);
                let resultXnCap, resultChiTiet;

                try {
                    resultXnCap = await apiRequest(TABLE_NAME_XN_CAP, 'Add', { Rows: [xuatNhapCap] });
                    console.log('Xuat nhap cap result:', resultXnCap);
                    toastr.success('Đã thêm thông tin Xuất nhập cáp thành công.', 'Thành công');
                } catch (xnCapError) {
                    console.error('Error adding to Xuat nhap cap:', xnCapError);
                    toastr.error('Lỗi khi thêm thông tin Xuất nhập cáp.', 'Lỗi');
                    throw new Error(`Lỗi khi thêm vào Xuất nhập cáp: ${xnCapError.message}`);
                }

                console.log('Sending Chi tiet XN CAP data:', chiTietXnCapList);
                try {
                    resultChiTiet = await apiRequest(TABLE_NAME_CHI_TIET, 'Add', { Rows: chiTietXnCapList });
                    console.log('Chi tiet XN CAP result:', resultChiTiet);
                    toastr.success('Đã thêm Chi tiết XN CÁP thành công.', 'Thành công');
                } catch (chiTietError) {
                    console.error('Error adding to Chi tiet XN CAP:', chiTietError);
                    toastr.error('Lỗi khi thêm Chi tiết XN CÁP.', 'Lỗi');
                    throw new Error(`Lỗi khi thêm vào Chi tiết XN CÁP: ${chiTietError.message}`);
                }

                const result = `
                    <h2>Kết quả Phiếu Xuất Nhập Kho</h2>
                    <h3>Xuất Nhập Cáp</h3>
                    <pre>${JSON.stringify(resultXnCap, null, 2)}</pre>
                    <h3>Chi tiết XN CÁP</h3>
                    <pre>${JSON.stringify(resultChiTiet, null, 2)}</pre>
                `;

                $('#result').html(result);
                toastr.success('Đã tạo Phiếu Xuất Nhập Kho thành công.', 'Hoàn tất');
            } catch (error) {
                console.error('Error submitting form:', error);
                $('#result').html(`<p class="error">Lỗi: ${error.message}</p>`);
                $('#debug').append(`<p>Chi tiết lỗi khi gửi form: ${error.stack}</p>`);
                toastr.error('Có lỗi xảy ra khi gửi form. Vui lòng thử lại.', 'Lỗi');
            } finally {
                $('#loadingIndicator').hide();
            }
        });

        async function initializeForm() {
            try {
                await loadMaKeHoach();
                await loadNhanVien();
                addCableForm();
                updateTuDenOptions();
                toastr.success('Đã khởi tạo form thành công.', 'Sẵn sàng');
            } catch (error) {
                console.error('Lỗi khi khởi tạo form:', error);
                $('#debug').append(`<p>Lỗi khi khởi tạo form: ${error.message}</p>`);
                toastr.error('Có lỗi xảy ra khi khởi tạo form. Vui lòng tải lại trang.', 'Lỗi');
            }
        }

        $(document).ready(function () {
            initializeForm();
        });
    </script>
</body>

</html>
