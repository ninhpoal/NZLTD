<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Nhập Thông Tin Kế Hoạch</title>
    <link rel="shortcut icon" href="Logo N có bóng/Logo N.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <link rel="stylesheet" type="text/css"
        href="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/css/toast@1.0.1/fuiToast.min.css">
    <script type="text/javascript"
        src="https://cdn.jsdelivr.net/gh/lelinh014756/fui-toast-js@master/assets/js/toast@1.0.1/fuiToast.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.1/dist/flowbite.min.js"></script>


</head>

<body class="bg-gray-100 min-h-screen p-8">
    <div id="fui-toast"></div>
    <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-xxl mx-auto">
        <h1 class="text-2xl font-bold mb-6 text-center text-blue-600">Form Nhập Thông Tin Kế Hoạch</h1>

        <input
            class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-400 focus:outline-none dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400"
            type="file" id="excelFile" accept=".xlsx, .xls">
        <button onclick="docFileExcel()" type="button"
            class="mt-4 px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">Đọc
            file Excel</button>
        <button type="button" id="submitVote" onclick="sendDataToAppSheet()"
            class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
            Đẩy dữ liệu lên appsheet
        </button>
        <button type="button" id="addBCGSButton" onclick="addBCGSData()"
    class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
    Thêm dữ liệu BCGS
</button>
        <div id="keHoachForm" class="    mx-auto p-6 bg-white shadow-md rounded-lg">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Kế Hoạch Form</h1>
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="ngayNhan"
                            class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-amber-600 bg-amber-200 uppercase last:mr-0 mr-1">Ngày
                            nhận *</label>
                        <input type="date" id="ngayNhan" name="ngayNhan" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="deadline"
                            class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-amber-600 bg-amber-200 uppercase last:mr-0 mr-1">Deadline
                            KH *</label>
                        <input type="date" id="deadline" name="deadline" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="maKeHoach"
                            class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-amber-600 bg-amber-200 uppercase last:mr-0 mr-1">Mã
                            kế hoạch
                            *</label>
                        <input type="text" id="maKeHoach" name="maKeHoach" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="pop"
                            class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-amber-600 bg-amber-200 uppercase last:mr-0 mr-1">POP
                            *</label>
                        <input type="text" id="pop" name="pop" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>

                </div>
                <div>
                    <div>
                        <label for="tenCongTrinh"
                            class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-amber-600 bg-amber-200 uppercase last:mr-0 mr-1">Tên
                            công trình
                            *</label>
                        <textarea type="text" id="tenCongTrinh" name="tenCongTrinh" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    <label for="diaChiThiCong" class="block text-sm font-medium text-gray-700 mb-1">Địa chỉ thi
                        công</label>
                    <input type="text" id="diaChiThiCong" name="diaChiThiCong"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="khuVuc"
                            class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-amber-600 bg-amber-200 uppercase last:mr-0 mr-1">Khu
                            vực *</label>
                        <div class="flex items-center space-x-2">
                            <select id="khuVuc" name="khuVuc" required
                                class="flex-grow px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Chọn khu vực</option>
                            </select>
                            <button type="button" onclick="themMoi('khuVuc')"
                                class="px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                Thêm mới
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="keHoach"
                            class="text-xs font-semibold inline-block py-1 px-2 uppercase rounded text-amber-600 bg-amber-200 uppercase last:mr-0 mr-1">Kế
                            hoạch *</label>
                        <div class="flex items-center space-x-2">
                            <select id="keHoach" name="keHoach" required
                                class="flex-grow px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Chọn kế hoạch</option>
                            </select>
                            <button type="button" onclick="themMoi('keHoach')"
                                class="px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                Thêm mới
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="nguoiGiaoViec" class="block text-sm font-medium text-gray-700 mb-1">Người giao
                            việc</label>
                        <div class="flex items-center space-x-2">
                            <select id="nguoiGiaoViec" name="nguoiGiaoViec"
                                class="flex-grow px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Chọn người giao việc</option>
                            </select>
                            <button type="button" onclick="themMoi('nguoiGiaoViec')"
                                class="px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                Thêm mới
                            </button>
                        </div>
                    </div>
                    <div>
                        <label for="giamSat" class="block text-sm font-medium text-gray-700 mb-1">Giám sát</label>
                        <div class="flex items-center space-x-2">
                            <select id="giamSat" name="giamSat"
                                class="flex-grow px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Chọn giám sát</option>
                            </select>
                            <button type="button" onclick="themMoi('giamSat')"
                                class="px-3 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                Thêm mới
                            </button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="tongBoChua" class="block text-sm font-medium text-gray-700 mb-1">Tổng bộ
                            chia</label>
                        <input type="number" id="tongBoChua" name="tongBoChua"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="tongTuODFTapDiem" class="block text-sm font-medium text-gray-700 mb-1">Tổng số
                            Tủ/ODF/tập điểm</label>
                        <input type="number" id="tongTuODFTapDiem" name="tongTuODFTapDiem"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="duToanCore" class="block text-sm font-medium text-gray-700 mb-1">Dự toán
                            Core</label>
                        <input type="number" id="duToanCore" name="duToanCore"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
            </div>

            <h2 class="text-xl font-semibold mt-8 mb-4">Thông tin BCSG</h2>
            <div class="overflow-x-auto shadow-md rounded-lg">
                <table id="bcsgTable" class="min-w-full bg-white">
                    <thead>
                        <tr class="bg-gray-100 text-gray-600 uppercase text-sm leading-normal">
                            <th class="py-3 px-2 text-left w-1/12">Tuyến cáp</th>
                            <th class="py-3 px-6 text-left w-1/4">Điểm đầu</th>
                            <th class="py-3 px-6 text-left w-1/4">Điểm cuối</th>
                            <th class="py-3 px-6 text-left w-1/6">Loại cáp</th>
                            <th class="py-3 px-6 text-left w-1/6">Dự toán</th>
                            <th class="py-3 px-6 text-center w-1/12">Thao tác</th>
                        </tr>
                    </thead>
                    <tbody id="bcsgTableBody">
                        <!-- Các hàng BCSG sẽ được thêm vào đây -->
                    </tbody>
                </table>
            </div>
            <button type="button" onclick="themHangBCSG()"
                class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Thêm BCSG
            </button>
        </div>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        // Constants for AppSheet API
        const appId = '0ffda765-62b7-4260-b7ed-5bcbb530b113';
        const accessKey = 'V2-OjHkE-1jfLk-F8bt0-QWJgC-QHUwP-mJIQN-WIpvd-ALOIF';
        const region = 'www';

        // Khởi tạo dữ liệu mới
        const duLieu = {
            khuVuc: ['FPT-HCM', 'FPT-BDG', 'FPT-VTU', 'FPT-TNH', 'FPT-BPC', 'FPT-BTN', 'FPT-LAN', 'NZ-HCM', 'Intecom', 'FPT-DNI', 'Nhật Minh', 'PA VietNam', 'BPC'],
            keHoach: ['SGx', 'Buiding', 'Di dời', 'Ngầm hóa', 'FTI', 'AON', 'Nâng Cấp', 'XLSC', 'Cắt chuyển', 'Metro', 'Hot', 'Thu hồi', 'Intecom', 'Bảo trì', 'Ring'],
            nguoiGiaoViec: ['Giáp VV', 'Cường TV', 'Sơn VT', 'Nghi NV', 'Thạo NT', 'Cường TQ', 'Kiệt NH', 'QLVH1 (Khiêm ND)', 'QLVH2 (Quý NT)', 'QLVH2 (Thế Anh)', 'QLVH3 (Thiện LTQ)', 'QLVH3 (Nguyên DT)', 'QLVH3 (Quang P)', 'QLVH3 (Khoa NA)', 'Cường LĐ', 'Sơn ĐT', 'Vương NN', 'Nhật NH', 'Hùng NQ DNI', 'Intecom', 'Nhật Minh', 'PhatMA', 'PA VietNam', 'ThanhTNM', 'Nam NQ', 'ThanhNT DNI'],
            giamSat: ['Giám sát A', 'Giám sát B', 'Giám sát C']
        };

        function apiRequest(tableName, action, data) {
            const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;
            return $.ajax({
                url: apiUrl,
                method: 'POST',
                headers: {
                    'ApplicationAccessKey': accessKey,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    Action: action,
                    Properties: {
                        Locale: 'vi-VN',
                        Timezone: 'Asia/Ho_Chi_Minh'
                    },
                    ...data
                })
            }).then(response => {
                return response;
            }).catch(error => {
                FuiToast.error("Lỗi hệ thống báo Admin để hỗ trợ.")

                throw error;
            });
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);

            });
        }
        async function sendDataToAppSheet() {
            return FuiToast.promise(
                (async () => {

                    // Kiểm tra dữ liệu đầu vào
                    const requiredFields = ['maKeHoach', 'tenCongTrinh', 'pop', 'tenCongTrinh', 'diaChiThiCong', 'khuVuc', 'keHoach', 'nguoiGiaoViec', 'deadline'];
                    for (const field of requiredFields) {
                        if (!document.getElementById(field).value) {

                            FuiToast.info(`Trường ${field} là bắt buộc.`)
                            return;

                        }
                    }

                    const duAnData = {
                        "Ngày nhận": formatDate(document.getElementById('ngayNhan').value),
                        "Deadline KH": formatDate(document.getElementById('deadline').value),
                        "Mã kế hoạch": document.getElementById('maKeHoach').value,
                        "Tên công trình": document.getElementById('tenCongTrinh').value,
                        "POP": document.getElementById('pop').value || '',
                        "Địa chỉ thi công": document.getElementById('diaChiThiCong').value || '',
                        "Khu vực": document.getElementById('khuVuc').value || '',
                        "Kế hoạch": document.getElementById('keHoach').value || '',
                        "Người giao việc": document.getElementById('nguoiGiaoViec').value || '',
                        "Giám sát": document.getElementById('giamSat').value || '',
                        "Tổng bộ chia": (document.getElementById('tongBoChua').value) || '',
                        "Tổng số Tủ/ODF/tập điểm": (document.getElementById('tongTuODFTapDiem').value) || '',
                        "Dự toán Core": (document.getElementById('duToanCore').value) || ''
                    };

                    console.log(duAnData)

                    const duAnResponse = await apiRequest('DUAN', 'Add', {
                        Rows: [duAnData]
                    });

                    if (!duAnResponse || duAnResponse.Failed) {
                        FuiToast.error(`Lỗi khi thêm dữ liệu vào DUAN: ${duAnResponse.FailureMessage || 'Không xác định'}`)
                    }

                    console.log("Dữ liệu DUAN đã được gửi thành công!");

                    const bcsgData = [];
                    document.querySelectorAll('#bcsgTableBody tr').forEach(row => {
                        const rowData = {
                            "Mã kế hoạch": duAnData["Mã kế hoạch"],
                            "POP": duAnData["POP"],
                            "Khu vực": duAnData["Khu vực"],
                            "Tuyến cáp": row.querySelector('[data-field="tuyenCap"]').value,
                            "Điểm đầu": row.querySelector('[data-field="diemDau"]').value,
                            "Điểm cuối": row.querySelector('[data-field="diemCuoi"]').value,

                            "Loại cáp": row.querySelector('[data-field="loaiCap"]').value,
                            "Dự toán": row.querySelector('[data-field="duToan"]').value
                        };
                        if (!rowData["Tuyến cáp"] || !rowData["Điểm đầu"] || !rowData["Điểm cuối"] || !rowData["Loại cáp"] || !rowData["Dự toán"]) {
                            FuiToast.info('Vui lòng điền đủ thông tin các dòng bạn đã thêm vào báo cáo giáo sát')

                        }
                        bcsgData.push(rowData);
                    });


                    if (bcsgData.length > 0) {

                        await apiRequest('BCGS', 'Add', { Rows: bcsgData });
                    }
                    const file = document.getElementById('excelFile').files[0];
                    filebase = await readFile(file);
                    const fileData = {
                        "Tên File": "File dự toán" + duAnData["Mã kế hoạch"] + duAnData["POP"],
                        "Key": duAnData["Mã kế hoạch"],
                        "File": filebase
                    };
                    await apiRequest('FILE', 'Add', { Rows: [fileData] });



                    return 'Dữ liệu đã được gửi thành công!';
                })(),
                {
                    loading: 'Đang gửi dữ liệu...',
                    success: (data) => {
                        console.log(data);
                        return data;
                    },
                    error: (error) => {
                        console.error('Lỗi khi gửi dữ liệu:', error);
                        return `Lỗi: ${error.message || 'Không xác định'}`;
                    },
                },
                {
                    isClose: true
                }
            );
        }
        function addBCGSData() {
            return FuiToast.promise(
                (async () => {
                    const bcsgData = [];
                    const maKeHoach = document.getElementById('maKeHoach').value;
                    const pop = document.getElementById('pop').value;
                    const khuVuc = document.getElementById('khuVuc').value;

                    if (!maKeHoach || !pop || !khuVuc) {
                        throw new Error('Vui lòng điền đầy đủ thông tin Mã kế hoạch, POP và Khu vực.');
                    }

                    document.querySelectorAll('#bcsgTableBody tr').forEach(row => {
                        const rowData = {
                            "Mã kế hoạch": maKeHoach,
                            "POP": pop,
                            "Khu vực": khuVuc,
                            "Tuyến cáp": row.querySelector('[data-field="tuyenCap"]').value,
                            "Điểm đầu": row.querySelector('[data-field="diemDau"]').value,
                            "Điểm cuối": row.querySelector('[data-field="diemCuoi"]').value,
                            "Loại cáp": row.querySelector('[data-field="loaiCap"]').value,
                            "Dự toán": row.querySelector('[data-field="duToan"]').value
                        };

                        if (!rowData["Tuyến cáp"] || !rowData["Điểm đầu"] || !rowData["Điểm cuối"] || !rowData["Loại cáp"] || !rowData["Dự toán"]) {
                            throw new Error('Vui lòng điền đủ thông tin các dòng bạn đã thêm vào báo cáo giám sát');
                        }

                        bcsgData.push(rowData);
                    });

                    if (bcsgData.length === 0) {
                        throw new Error('Không có dữ liệu BCGS để thêm.');
                    }

                    const response = await apiRequest('BCGS', 'Add', { Rows: bcsgData });

                    if (!response || response.Failed) {
                        throw new Error(`Lỗi khi thêm dữ liệu vào BCGS: ${response.FailureMessage || 'Không xác định'}`);
                    }

                    return 'Dữ liệu BCGS đã được gửi thành công!';
                })(),
                {
                    loading: 'Đang gửi dữ liệu BCGS...',
                    success: (data) => {
                        console.log(data);
                        return data;
                    },
                    error: (error) => {
                        console.error('Lỗi khi gửi dữ liệu BCGS:', error);
                        return `Lỗi: ${error.message || 'Không xác định'}`;
                    },
                },
                {
                    isClose: true
                }
            );
        }
        // Hàm hỗ trợ để chuyển đổi chuỗi thành số nguyên hoặc trả về 0 nếu không hợp lệ
        function parseIntOrZero(value) {
            const parsedValue = parseInt(value, 10);
            return isNaN(parsedValue) ? 0 : parsedValue;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }
        // Hàm điền dữ liệu vào select
        function dienDuLieu(id) {
            const select = document.getElementById(id);
            select.innerHTML = '<option value="">Chọn ' + id + '</option>';
            duLieu[id].forEach(item => {
                const option = document.createElement('option');
                option.value = item;
                option.textContent = item;
                select.appendChild(option);
            });
        }

        function themHangBCSG() {
            const tableBody = document.getElementById('bcsgTableBody');
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
        <td><input type="text" class="border p-1 w-full" data-field="tuyenCap" required></td>
        <td><input type="text" class="border p-1 w-full" data-field="diemDau" required></td>
        <td><input type="text" class="border p-1 w-full" data-field="diemCuoi" required></td>
        <td>
            <select class="border p-1 w-full" data-field="loaiCap" required>
                <option value="">Chọn loại cáp</option>
                <optgroup label="Cáp treo">
                     <option value="04FO">04FO</option>
                    <option value="08FO">08FO</option>
                    <option value="12FO">12FO</option>
                    <option value="16FO">16FO</option>
                    <option value="24FO">24FO</option>
                    <option value="48FO">48FO</option>
                    <option value="96FO">96FO</option>
                    <option value="144FO">144FO</option>
                </optgroup>
                <optgroup label="Cáp ngầm">
                    <option value="04DU">04DU</option>
                    <option value="06DU">06DU</option>
                    <option value="08DU">08DU</option>
                    <option value="12DU">12DU</option>
                    <option value="16DU">16DU</option>
                    <option value="24DU">24DU</option>
                    <option value="48DU">48DU</option>
                    <option value="96DU">96DU</option>
                    <option value="144DU">144DU</option>

                </optgroup>
                <optgroup label="Cáp Mipan">
                    <option value="04FM">04FM</option>
                    <option value="08FM">08FM</option>
                    <option value="12FM">12FM</option>  
                    <option value="16FM">16FM</option>
                    <option value="24FM">24FM</option>
                </optgroup>
                <optgroup label="Cáp khác">
                    <option value="24ADSS">24ADSS</option>
                   </optgroup>

            </select>
        </td>
        <td><input type="number" class="border p-1 w-full" data-field="duToan" required></td>
        <td class="text-center">
            <button onclick="xoaHangBCSG(this)" class="text-white bg-red-700 hover:bg-red-800 focus:outline-none focus:ring-4 focus:ring-red-300 font-medium rounded-full text-sm px-5 py-2.5 text-center me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900">Xóa</button>
        </td>
    `;
            return newRow;
        }

        function docFileExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];

            if (!file) {
                FuiToast.error('Vui lòng chọn một file Excel trước khi đọc.');
                return;
            }

            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });

                // Đọc sheet NV-DTVT
                const sheetDTVT = workbook.Sheets['NV-DTVT'];
                const sheetTT = workbook.Sheets['TT'];
                const sheetNVTH = workbook.Sheets['NV-TH'];

                document.getElementById('maKeHoach').value = sheetDTVT['C8']?.v || '';
                document.getElementById('tenCongTrinh').value = sheetDTVT['A7']?.v || '';
                document.getElementById('pop').value = sheetTT['E12']?.v || '';
                document.getElementById('diaChiThiCong').value = sheetTT['E22']?.v || '';

                document.getElementById('duToanCore').value = sheetNVTH['E18']?.v || '';
                document.getElementById('tongTuODFTapDiem').value = sheetNVTH['H18']?.v || '';
                document.getElementById('tongBoChua').value = (sheetNVTH['K18']?.v) / 8 || '';

                // Đọc sheet NV-TM
                const sheetTM = workbook.Sheets['NV-TM'];
                const range = XLSX.utils.decode_range(sheetTM['!ref']);
                const bcsgData = [];

                for (let R = 13; R <= Math.min(513, range.e.r); ++R) {
                    const row = {
                        tuyenCap: sheetTM[`A${R}`]?.v,
                        diemDau: sheetTM[`C${R}`]?.v,
                        diemCuoi: sheetTM[`D${R}`]?.v,
                        loaiCap: sheetTM[`E${R}`]?.v,
                        duToan: sheetTM[`F${R}`]?.v
                    };

                    if (row.duToan > 0) {
                        bcsgData.push(row);
                    }
                }

                // Xóa các hàng BCSG hiện có
                const bcsgTableBody = document.getElementById('bcsgTableBody');
                bcsgTableBody.innerHTML = '';

                // Thêm dữ liệu BCSG mới
                bcsgData.forEach(row => {
                    themHangBCSG();
                    const newRow = bcsgTableBody.lastElementChild;
                    newRow.querySelector('[data-field="tuyenCap"]').value = row.tuyenCap || '';
                    newRow.querySelector('[data-field="diemDau"]').value = row.diemDau || '';
                    newRow.querySelector('[data-field="diemCuoi"]').value = row.diemCuoi || '';
                    newRow.querySelector('[data-field="loaiCap"]').value = row.loaiCap || '';
                    newRow.querySelector('[data-field="duToan"]').value = row.duToan || '';
                });

                FuiToast.success('Đã đọc file Excel thành công');
            };

            reader.onerror = function (ex) {
                console.error(ex);
                FuiToast.error('Đã xảy ra lỗi khi đọc file Excel. Vui lòng thử lại.');
            };

            reader.readAsArrayBuffer(file);
        }    // Hàm xóa hàng BCSG
        function xoaHangBCSG(button) {
            const row = button.closest('tr');
            row.remove();
        }

        // Hàm thêm mới
        function themMoi(loai) {
            const giaTri = prompt(`Nhập ${loai} mới:`);
            if (giaTri && !duLieu[loai].includes(giaTri)) {
                duLieu[loai].push(giaTri);
                dienDuLieu(loai);
                document.getElementById(loai).value = giaTri;
            }
        }

        // Điền dữ liệu khi trang load
        window.onload = function () {
            document.getElementById('ngayNhan').valueAsDate = new Date();
            dienDuLieu('khuVuc');
            dienDuLieu('keHoach');
            dienDuLieu('nguoiGiaoViec');
            dienDuLieu('giamSat');
            themHangBCSG();
        };

    </script>
</body>

</html>