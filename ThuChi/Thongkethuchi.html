<!DOCTYPE html>
<html lang="vi" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NZ ERP Chi phí</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">

    <!-- XLSX Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <!-- Optional: Add Highcharts theme if you want -->
    <script src="https://code.highcharts.com/themes/high-contrast-dark.js"></script>


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            font-family: 'Inter', sans-serif;
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .card-stats {
            transition: transform 0.2s ease-in-out;
        }

        .card-stats:hover {
            transform: translateY(-5px);
        }

        .sidebar {
            transition: all 0.3s ease;
        }

        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Checkbox styles */
        .checkbox-container {
            position: relative;
            padding-left: 25px;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }

        .checkmark {
            position: absolute;
            top: 0;
            left: 0;
            height: 18px;
            width: 18px;
            background-color: #eee;
            border-radius: 3px;
        }

        .checkbox-container:hover input~.checkmark {
            background-color: #ccc;
        }

        .checkbox-container input:checked~.checkmark {
            background-color: #4f46e5;
        }
    </style>
  <style>
    /* Highlight styles for selected checkboxes */
    .checkbox-container.selected {
        @apply bg-indigo-50 dark:bg-indigo-900/30 border-l-4 border-indigo-500;
    }

    .checkbox-container {
        @apply border-l-4 border-transparent transition-all duration-200;
    }

    .checkbox-container:hover {
        @apply bg-gray-50 dark:bg-gray-700/50;
    }

    .checkbox-container input[type="checkbox"]:checked + span {
        @apply text-indigo-600 dark:text-indigo-400 font-medium;
    }

    /* Animation for selection */
    .checkbox-container.selected {
        animation: selectPulse 0.4s ease-in-out;
    }

    @keyframes selectPulse {
        0% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.02);
        }
        100% {
            transform: scale(1);
        }
    }
</style>
</head>

<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-200">
    <!-- Loading Spinner -->
    <div id="loading" class="loading">
        <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-lg fixed top-0 left-0 right-0 z-30">
        <div class="max-w-9xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <button id="toggleFilters"
                        class="lg:hidden p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-bars text-gray-600 dark:text-gray-300"></i>
                    </button>
                    <div class="flex items-center space-x-3">
                        <img src="https://nzltd.vn/wp-content/uploads/2024/09/Logo-NZ-1-1024x979.png" alt="Logo"
                            class="h-8 w-8">
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">NZ ERP PRO CHI PHÍ</h1>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="dateRange" class="text-sm text-gray-600 dark:text-gray-300"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="flex min-h-screen pt-16">
        <!-- Sidebar Filters -->
        <aside id="filtersSidebar"
            class="fixed left-0 top-16 bottom-0 w-80 bg-white dark:bg-gray-800 shadow-xl transform -translate-x-full lg:translate-x-0 transition-transform duration-200 ease-in-out z-20">
            <!-- Main scrollable content -->
            <div class="absolute top-0 bottom-[160px] left-0 right-0 overflow-y-auto custom-scrollbar">
                <div class="p-6 space-y-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Bộ lọc</h2>
                    </div>

                    <!-- Time Filter -->
                    <div class="filter-group">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Ngày giải
                            ngân</label>
                        <div class="space-y-3">
                            <select id="timeFilterType"
                                class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                <option value="custom">Tùy chỉnh</option>
                                <option value="week">Theo tuần</option>
                                <option value="month">Theo tháng</option>
                                <option value="year">Theo năm</option>
                                <option value="quarter">Theo quý</option>
                            </select>

                            <div id="customDateRange" class="space-y-2">
                                <div class="relative">
                                    <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Từ ngày</label>
                                    <input type="date" id="fromDate"
                                        class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                                <div class="relative">
                                    <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Đến ngày</label>
                                    <input type="date" id="toDate"
                                        class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>

                            <div id="weekSelector" class="hidden">
                                <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Chọn tuần</label>
                                <input type="week" id="weekFilter"
                                    class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>

                            <div id="monthSelector" class="hidden">
                                <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Chọn tháng</label>
                                <input type="month" id="monthFilter"
                                    class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                            </div>

                            <div id="yearSelector" class="hidden">
                                <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Chọn năm</label>
                                <select id="yearFilter"
                                    class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                </select>
                            </div>

                            <div id="quarterSelector" class="hidden space-y-2">
                                <div>
                                    <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Chọn quý</label>
                                    <select id="quarterFilter"
                                        class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                        <option value="1">Quý 1</option>
                                        <option value="2">Quý 2</option>
                                        <option value="3">Quý 3</option>
                                        <option value="4">Quý 4</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-500 dark:text-gray-400 mb-1 block">Chọn năm</label>
                                    <select id="quarterYearFilter"
                                        class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div
                        class="filter-group p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-indigo-500 dark:hover:border-indigo-500 transition-colors duration-200">
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                Trạng thái
                            </label>
                            <span id="selectedTrangThaiCount"
                                class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400 px-2 py-1 rounded-full">
                                0 đã chọn
                            </span>
                        </div>
                        <div class="relative">
                            <input type="text" id="trangThaiSearch"
                                class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Tìm kiếm trạng thái...">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <div id="trangThaiFilter"
                            class="mt-2 max-h-40 overflow-y-auto space-y-1 bg-gray-50 dark:bg-gray-700 rounded-lg p-2 custom-scrollbar">
                        </div>
                    </div>
                    <!-- Area Filter -->
                    <div
                        class="filter-group p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-indigo-500 dark:hover:border-indigo-500 transition-colors duration-200">
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                Khu vực
                            </label>
                            <span id="selectedKhuVucCount"
                                class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400 px-2 py-1 rounded-full">
                                0 đã chọn
                            </span>
                        </div>
                        <div class="relative">
                            <input type="text" id="khuVucSearch"
                                class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Tìm kiếm khu vực...">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <div id="khuVucFilter"
                            class="mt-2 max-h-40 overflow-y-auto space-y-1 bg-gray-50 dark:bg-gray-700 rounded-lg p-2 custom-scrollbar">
                        </div>
                    </div>

                    <!-- Project Filter -->
                    <div
                        class="filter-group p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-indigo-500 dark:hover:border-indigo-500 transition-colors duration-200">
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                Dự án
                            </label>
                            <span id="selectedDuAnCount"
                                class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400 px-2 py-1 rounded-full">
                                0 đã chọn
                            </span>
                        </div>
                        <div class="relative">
                            <input type="text" id="duAnSearch"
                                class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Tìm kiếm dự án...">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <div id="duAnFilter"
                            class="mt-2 max-h-40 overflow-y-auto space-y-1 bg-gray-50 dark:bg-gray-700 rounded-lg p-2 custom-scrollbar">
                        </div>
                    </div>

                    <!-- Expense Code Filter -->
                    <div
                        class="filter-group p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-indigo-500 dark:hover:border-indigo-500 transition-colors duration-200">
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                Mã CHI
                            </label>
                            <span id="selectedMaChiCount"
                                class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400 px-2 py-1 rounded-full">
                                0 đã chọn
                            </span>
                        </div>
                        <div class="relative">
                            <input type="text" id="maChiSearch"
                                class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Tìm kiếm mã chi...">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <div id="maChiFilter"
                            class="mt-2 max-h-40 overflow-y-auto space-y-1 bg-gray-50 dark:bg-gray-700 rounded-lg p-2 custom-scrollbar">
                        </div>
                    </div>

                    <!-- Employee Filter -->
                    <div
                        class="filter-group p-4 rounded-lg border border-gray-200 dark:border-gray-700 hover:border-indigo-500 dark:hover:border-indigo-500 transition-colors duration-200">
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-medium text-gray-700 dark:text-gray-300">
                                Nhân viên thực hiện
                            </label>
                            <span id="selectedNhanVienCount"
                                class="text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-600 dark:text-indigo-400 px-2 py-1 rounded-full">
                                0 đã chọn
                            </span>
                        </div>
                        <div class="relative">
                            <input type="text" id="nhanVienSearch"
                                class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 pl-9 pr-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                                placeholder="Tìm kiếm nhân viên...">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <div id="nhanVienFilter"
                            class="mt-2 max-h-40 overflow-y-auto space-y-1 bg-gray-50 dark:bg-gray-700 rounded-lg p-2 custom-scrollbar">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fixed bottom buttons -->
            <div
                class="absolute bottom-0 left-0 right-0 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 space-y-3">
                <button id="applyFilters"
                    class="w-full flex items-center justify-center px-4 py-3 space-x-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <i class="fas fa-filter"></i>
                    <span>Áp dụng bộ lọc</span>
                </button>

                <div class="grid grid-cols-2 gap-3">
                    <button id="resetFilters"
                        class="flex items-center justify-center px-4 py-3 space-x-2 bg-white hover:bg-gray-50 text-gray-700 rounded-lg shadow-lg hover:shadow-xl border border-gray-200 transition-all duration-200 focus:ring-2 focus:ring-offset-2 focus:ring-gray-500">
                        <i class="fas fa-undo"></i>
                        <span>Đặt lại</span>
                    </button>

                    <button id="exportExcel"
                        class="flex items-center justify-center px-4 py-3 space-x-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                        <i class="fas fa-file-excel"></i>
                        <span>Xuất Excel</span>
                    </button>
                </div>
            </div>
        </aside>
        <!-- Main Content -->
        <main class="flex-1 lg:ml-80 p-6">
            <div class="max-w-9xl mx-auto">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <!-- Total Amount Card -->
                    <div class="card-stats bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-indigo-100 dark:bg-indigo-900">
                                <i class="fas fa-money-bill text-indigo-600 dark:text-indigo-400"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Tổng chi phí</p>
                                <p id="totalAmount" class="text-xl font-semibold text-gray-900 dark:text-white">0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Count by Area Card -->
                    <div class="card-stats bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 dark:bg-blue-900">
                                <i class="fas fa-map-marker text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Khu vực</p>
                                <p id="areaCount" class="text-xl font-semibold text-gray-900 dark:text-white">0</p>
                            </div>
                        </div>
                        <div id="areaStats" class="mt-4 space-y-2"></div>
                    </div>

                    <!-- Count by Project Card -->
                    <div class="card-stats bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 dark:bg-green-900">
                                <i class="fas fa-project-diagram text-green-600 dark:text-green-400"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Dự án</p>
                                <p id="projectCount" class="text-xl font-semibold text-gray-900 dark:text-white">0</p>
                            </div>
                        </div>
                        <div id="projectStats" class="mt-4 space-y-2"></div>
                    </div>

                    <!-- Count by Expense Type Card -->
                    <div class="card-stats bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 dark:bg-purple-900">
                                <i class="fas fa-tags text-purple-600 dark:text-purple-400"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Loại chi phí</p>
                                <p id="expenseTypeCount" class="text-xl font-semibold text-gray-900 dark:text-white">0
                                </p>
                            </div>
                        </div>
                        <div id="expenseTypeStats" class="mt-4 space-y-2"></div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
                    <div class="p-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Chi tiết chi phí</h3>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="tableSearch" placeholder="Tìm kiếm..."
                                    class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 text-sm">
                                <select id="pageSize"
                                    class="bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg py-2 px-3 text-sm">
                                    <option value="10">10 dòng</option>
                                    <option value="20">20 dòng</option>
                                    <option value="50">50 dòng</option>
                                    <option value="100">100 dòng</option>
                                </select>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer"
                                            data-sort="Ngày giải ngân">
                                            Ngày giải ngân
                                            <i class="fas fa-sort ml-1"></i>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer"
                                            data-sort="Ngày giải ngân">
                                            Ngày tạo
                                            <i class="fas fa-sort ml-1"></i>
                                        </th>

                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer"
                                            data-sort="KHU VỰC">
                                            Khu vực
                                            <i class="fas fa-sort ml-1"></i>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer"
                                            data-sort="Dự án">
                                            Dự án
                                            <i class="fas fa-sort ml-1"></i>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer"
                                            data-sort="Mã CHI">
                                            Mã CHI
                                            <i class="fas fa-sort ml-1"></i>
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider cursor-pointer"
                                            data-sort="SỐ TIỀN">
                                            Số tiền
                                            <i class="fas fa-sort ml-1"></i>
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                            Nhân viên
                                        </th>
                                        <th
                                            class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                                            Nội dung
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="expenseTableBody"
                                    class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Table rows will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination -->
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex items-center text-sm text-gray-500 dark:text-gray-400">
                                Hiển thị <span id="startIndex">0</span> - <span id="endIndex">0</span> của <span
                                    id="totalItems">0</span> kết quả
                            </div>
                            <div class="flex items-center space-x-2">
                                <button id="prevPage"
                                    class="px-3 py-1 rounded border border-gray-300 dark:border-gray-600 text-sm disabled:opacity-50">
                                    <i class="fas fa-chevron-left"></i>
                                </button>
                                <div id="pageNumbers" class="flex items-center space-x-1">
                                    <!-- Page numbers will be inserted here -->
                                </div>
                                <button id="nextPage"
                                    class="px-3 py-1 rounded border border-gray-300 dark:border-gray-600 text-sm disabled:opacity-50">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-10 hidden lg:hidden"></div>
    <script>
        // Global variables
        let danhsachchi = [];
        let currentPage = 1;
        let pageSize = 10;
        let sortColumn = 'Ngày giải ngân';
        let sortDirection = 'desc';
        let filteredData = [];

        // Format helpers
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        };

        const formatDate = (dateString) => {
            const date = new Date(dateString);
            return new Intl.DateTimeFormat('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        };
        // API Configuration
        const appId = '1a8d9270-a4ff-46b8-94fc-db1e4632f273';
        const accessKey = 'V2-IEkJl-GKXgi-aBjtl-fN3Ur-QQSYX-Ggn6e-m9pkA-GtxEU';
        const region = 'www';

        // API Request function
        async function apiRequest(tableName, action, data, Properties) {
            const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'ApplicationAccessKey': accessKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        Action: action,
                        ...Properties,
                        ...data
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error("API Error:", error);
                throw error;
            }
        }

        // Fetch data from API
        async function fetchChiphi() {
            try {
                const response = await apiRequest('Chi', 'Find', {}, {
                    Properties: { Selector: `Filter(Chi, true)` }
                });
                if (!Array.isArray(response) || response.length === 0) {
                    throw new Error("Invalid data received from API");
                }
                return response;
            } catch (error) {
                console.error("Error fetching data from AppSheet:", error);
                throw error;
            }
        }

        // Initialize function
        async function init() {
            try {
                // Show loading state
                document.getElementById('loading').classList.remove('hidden');

                // Fetch data
                danhsachchi = await fetchChiphi();

                // Set default values for filtering
                filteredData = [...danhsachchi];

                // Set initial sort
                sortColumn = 'Ngày giải ngân';
                sortDirection = 'desc';

                // Initialize date range
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

                document.getElementById('fromDate').valueAsDate = firstDayOfMonth;
                document.getElementById('toDate').valueAsDate = today;

                return true;
            } catch (error) {
                console.error("Initialization error:", error);
                throw error;
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        // Filter functions
        const getSelectedValues = (name) => {
            return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`))
                .map(cb => cb.value);
        };
        // Time filter handler
        document.getElementById('timeFilterType').addEventListener('change', function () {
            // Hide all selectors
            ['customDateRange', 'weekSelector', 'monthSelector', 'yearSelector', 'quarterSelector'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });

            // Show selected selector
            const selectedSelector = document.getElementById(this.value + 'Selector');
            if (selectedSelector) {
                selectedSelector.classList.remove('hidden');
            }
            if (this.value === 'custom') {
                document.getElementById('customDateRange').classList.remove('hidden');
            }
        });

        // Button hover effects
        const buttons = document.querySelectorAll('button');
        buttons.forEach(button => {
            button.addEventListener('mouseenter', () => {
                button.classList.add('transform', 'scale-105');
            });
            button.addEventListener('mouseleave', () => {
                button.classList.remove('transform', 'scale-105');
            });
        });

        const getTimeRange = () => {
            const timeFilterType = document.getElementById('timeFilterType').value;
            let fromDate, toDate;

            switch (timeFilterType) {
                case 'custom':
                    fromDate = document.getElementById('fromDate').value;
                    toDate = document.getElementById('toDate').value;
                    break;

                case 'week':
                    const weekInput = document.getElementById('weekFilter').value; // Format: 2024-W01
                    if (weekInput) {
                        const [year, weekNum] = weekInput.split('-W');
                        const weekRange = getWeekRange(parseInt(weekNum), parseInt(year));
                        fromDate = weekRange.start;
                        toDate = weekRange.end;

                        // Update display of selected week range
                        const dateRangeDisplay = document.getElementById('dateRange');
                        if (dateRangeDisplay) {
                            dateRangeDisplay.textContent = formatDateRange(fromDate, toDate);
                        }
                    }
                    break;

                case 'month':
                    const monthInput = document.getElementById('monthFilter').value; // Format: 2024-01
                    if (monthInput) {
                        const [year, month] = monthInput.split('-');
                        fromDate = new Date(year, parseInt(month) - 1, 1);
                        toDate = new Date(year, parseInt(month), 0);
                    }
                    break;

                case 'quarter':
                    const quarter = parseInt(document.getElementById('quarterFilter').value);
                    const yearQuarter = document.getElementById('quarterYearFilter').value;
                    if (quarter && yearQuarter) {
                        const startMonth = (quarter - 1) * 3;
                        fromDate = new Date(yearQuarter, startMonth, 1);
                        toDate = new Date(yearQuarter, startMonth + 3, 0);
                    }
                    break;

                case 'year':
                    const yearInput = document.getElementById('yearFilter').value;
                    if (yearInput) {
                        fromDate = new Date(yearInput, 0, 1);
                        toDate = new Date(yearInput, 11, 31);
                    }
                    break;
            }

            return {
                fromDate: fromDate ? new Date(fromDate) : null,
                toDate: toDate ? new Date(toDate) : null
            };
        };

        // Helper function to get date from ISO week
        const getDateOfISOWeek = (week, year) => {
            // Create a date object for January 1st of the given year
            const firstDayOfYear = new Date(year, 0, 1);

            // Get the weekday number for January 1st (0-6, where 0 is Sunday)
            const dayOffset = firstDayOfYear.getDay();

            // Calculate the date of Monday of week 1
            // If January 1st is not a Monday, move to the next Monday
            const firstMonday = new Date(year, 0, 1 + (8 - dayOffset));
            if (dayOffset <= 4) {
                firstMonday.setDate(firstMonday.getDate() - 7);
            }

            // Calculate the date of the Monday of the desired week
            const targetDate = new Date(firstMonday);
            targetDate.setDate(firstMonday.getDate() + (week - 1) * 7);

            return targetDate;
        };
        // Helper function to get current week number
        const getCurrentWeekNumber = () => {
            const currentDate = new Date();
            const startDate = new Date(currentDate.getFullYear(), 0, 1);
            const days = Math.floor((currentDate - startDate) / (24 * 60 * 60 * 1000));

            const weekNumber = Math.ceil(days / 7);
            return weekNumber;
        };

        // Helper function to get the week range (start and end dates) for display
        const getWeekRange = (week, year) => {
            const startDate = getDateOfISOWeek(week, year);
            const endDate = new Date(startDate);
            endDate.setDate(startDate.getDate() + 6);

            return {
                start: startDate,
                end: endDate
            };
        };
        // Helper function to format date range for display
        const formatDateRange = (start, end) => {
            const formatOptions = {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            };

            return `${start.toLocaleDateString('vi-VN', formatOptions)} - ${end.toLocaleDateString('vi-VN', formatOptions)}`;
        };
        const filterData = () => {
            const timeRange = getTimeRange();
            const selectedKhuVucs = getSelectedValues('khuVuc');
            const selectedDuAns = getSelectedValues('duAn');
            const selectedMaChis = getSelectedValues('maChi');
            const selectedNhanViens = getSelectedValues('nhanVien');
            const selectedTrangThais = getSelectedValues('trangThai'); // Add this line
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();

            return danhsachchi.filter(item => {
                const itemDate = new Date(item["Ngày giải ngân"]);
                const matchesTime = (!timeRange.fromDate || itemDate >= timeRange.fromDate) &&
                    (!timeRange.toDate || itemDate <= timeRange.toDate);

                const matchesKhuVuc = selectedKhuVucs.length === 0 || selectedKhuVucs.includes(item["KHU VỰC"]);
                const matchesDuAn = selectedDuAns.length === 0 || selectedDuAns.includes(item["Dự án"]);
                const matchesMaChi = selectedMaChis.length === 0 || selectedMaChis.includes(item["Mã CHI"]);
                const matchesNhanVien = selectedNhanViens.length === 0 || selectedNhanViens.includes(item["NHÂN VIÊN THỰC HIỆN"]);
                const matchesTrangThai = selectedTrangThais.length === 0 || selectedTrangThais.includes(item["TRẠNG THÁI"]); // Add this line

                const matchesSearch = searchTerm === '' ||
                    Object.values(item).some(value =>
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );

                return matchesTime && matchesKhuVuc && matchesDuAn && matchesMaChi &&
                    matchesNhanVien && matchesTrangThai && matchesSearch; // Update this line
            });
        };


        // Update UI
        const updateUI = () => {
            filteredData = filterData();
            updateStats(filteredData);
            updateTable();
            updatePagination();
            updateFilterCount();
        };

        const updateStats = (data) => {
            // Calculate statistics
            const totalAmount = data.reduce((sum, item) => sum + parseFloat(item["SỐ TIỀN"]), 0);
            const areaStats = calculateStats(data, "KHU VỰC");
            const projectStats = calculateStats(data, "Dự án");
            const expenseTypeStats = calculateStats(data, "Mã CHI");

            // Update UI
            document.getElementById('totalAmount').textContent = formatCurrency(totalAmount);
            document.getElementById('areaCount').textContent = Object.keys(areaStats).length;
            document.getElementById('projectCount').textContent = Object.keys(projectStats).length;
            document.getElementById('expenseTypeCount').textContent = Object.keys(expenseTypeStats).length;

            // Update detailed stats
            updateDetailedStats('areaStats', areaStats);
            updateDetailedStats('projectStats', projectStats);
            updateDetailedStats('expenseTypeStats', expenseTypeStats);
        };

        const calculateStats = (data, field) => {
            return data.reduce((acc, item) => {
                const key = item[field];
                if (!acc[key]) {
                    acc[key] = {
                        count: 0,
                        amount: 0
                    };
                }
                acc[key].count++;
                acc[key].amount += parseFloat(item["SỐ TIỀN"]);
                return acc;
            }, {});
        };

        const updateDetailedStats = (containerId, stats) => {
            const container = document.getElementById(containerId);
            const topStats = Object.entries(stats)
                .sort((a, b) => b[1].amount - a[1].amount)
                .slice(0, 3);

            container.innerHTML = topStats.map(([key, value]) => `
        <div class="flex justify-between items-center text-sm">
            <span class="text-gray-600 dark:text-gray-400 truncate" title="${key}">${key}</span>
            <span class="text-gray-900 dark:text-gray-100 font-medium">${formatCurrency(value.amount)}</span>
        </div>
    `).join('');
        };

        // Function to update filter count badges
        const updateFilterCount = (filterId, count) => {
            const badge = document.getElementById(`selected${filterId}Count`);
            if (badge) {
                badge.textContent = `${count} đã chọn`;

                // Update parent filter group active state
                const filterGroup = badge.closest('.filter-group');
                if (filterGroup) {
                    filterGroup.classList.toggle('active', count > 0);
                }
            }
        };
        // Function to init filter group
        const initFilterGroup = (groupId, data, searchId) => {
            const container = document.getElementById(`${groupId}Filter`);
            const searchInput = document.getElementById(searchId);

            // Generate checkboxes
            const checkboxes = data.map(item =>
                generateCheckboxItem(`${groupId}-${item}`, item, groupId)
            ).join('');

            container.innerHTML = checkboxes;

            // Add event listeners
            const inputs = container.querySelectorAll('input[type="checkbox"]');
            inputs.forEach(input => {
                input.addEventListener('change', () => {
                    const checkedCount = Array.from(inputs).filter(i => i.checked).length;
                    updateFilterCount(groupId.charAt(0).toUpperCase() + groupId.slice(1), checkedCount);
                });
            });

            // Search functionality
            if (searchInput) {
                searchInput.addEventListener('input', debounce((e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    inputs.forEach(input => {
                        const item = input.closest('.checkbox-container');
                        const text = input.nextElementSibling.textContent.toLowerCase();
                        item.classList.toggle('hidden', !text.includes(searchTerm));
                    });
                }, 300));
            }
        };

        // Table functions
        const updateTable = () => {
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, filteredData.length);

            // Sort data
            const sortedData = [...filteredData].sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];

                // Convert to numbers for numeric columns
                if (sortColumn === "SỐ TIỀN") {
                    aVal = parseFloat(aVal);
                    bVal = parseFloat(bVal);
                }
                // Convert to dates for date columns
                else if (sortColumn === "Ngày giải ngân") {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }

                if (sortDirection === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });

            const tableBody = document.getElementById('expenseTableBody');
            tableBody.innerHTML = sortedData.slice(startIndex, endIndex).map(item => `
        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-300">
                ${formatDate(item["Ngày giải ngân"])}
            </td>
                 <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-300">
                ${formatDate(item["Thời gian"])}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-300">
                ${item["KHU VỰC"]}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-300">
                ${item["Dự án"]}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-300">
                ${item["Mã CHI"]}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-300">
                ${formatCurrency(parseFloat(item["SỐ TIỀN"]))}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-gray-300">
                ${item["NHÂN VIÊN THỰC HIỆN"]}
            </td>
            <td class="px-6 py-4 text-sm text-gray-900 dark:text-gray-300">
                ${item["NỘI DUNG"]}
            </td>
        </tr>
    `).join('');

            // Update counter
            document.getElementById('startIndex').textContent = startIndex + 1;
            document.getElementById('endIndex').textContent = endIndex;
            document.getElementById('totalItems').textContent = filteredData.length;
        };
        // Function to generate checkbox items
        const generateCheckboxItem = (id, value, name) => `
    <div class="checkbox-container filter-transition">
        <label class="flex items-center w-full">
            <input type="checkbox" 
                   id="${id}" 
                   value="${value}" 
                   name="${name}"
                   class="form-checkbox">
            <span class="filter-transition">${value}</span>
        </label>
    </div>
`;

const updateCheckboxStyles = () => {
        document.querySelectorAll('.checkbox-container input[type="checkbox"]').forEach(checkbox => {
            const container = checkbox.closest('.checkbox-container');
            if (checkbox.checked) {
                container.classList.add('selected');
            } else {
                container.classList.remove('selected');
            }
        });
    };
        const updatePagination = () => {
            const totalPages = Math.ceil(filteredData.length / pageSize);
            const pageNumbers = document.getElementById('pageNumbers');
            const prevButton = document.getElementById('prevPage');
            const nextButton = document.getElementById('nextPage');

            // Enable/disable prev/next buttons
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;

            // Generate page numbers
            let pagesHtml = '';
            const maxPages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);

            if (endPage - startPage + 1 < maxPages) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }

            if (startPage > 1) {
                pagesHtml += `
            <button class="px-3 py-1 rounded border border-gray-300 dark:border-gray-600 text-sm" data-page="1">1</button>
            ${startPage > 2 ? '<span class="px-2">...</span>' : ''}
        `;
            }

            for (let i = startPage; i <= endPage; i++) {
                pagesHtml += `
            <button class="px-3 py-1 rounded border ${currentPage === i ?
                        'bg-indigo-600 text-white' :
                        'border-gray-300 dark:border-gray-600'} text-sm" 
                data-page="${i}">${i}</button>
        `;
            }

            if (endPage < totalPages) {
                pagesHtml += `
            ${endPage < totalPages - 1 ? '<span class="px-2">...</span>' : ''}
            <button class="px-3 py-1 rounded border border-gray-300 dark:border-gray-600 text-sm" 
                data-page="${totalPages}">${totalPages}</button>
        `;
            }

            pageNumbers.innerHTML = pagesHtml;
        };

        // Initialize filters
        const initializeFilters = () => {
            // Get unique values
            const khuVucs = [...new Set(danhsachchi.map(item => item["KHU VỰC"]))].sort();
            const duAns = [...new Set(danhsachchi.map(item => item["Dự án"]))].sort();
            const maChis = [...new Set(danhsachchi.map(item => item["Mã CHI"]))].sort();
            const nhanViens = [...new Set(danhsachchi.map(item => item["NHÂN VIÊN THỰC HIỆN"]))].sort();
            const trangThais = [...new Set(danhsachchi.map(item => item["TRẠNG THÁI"]))].sort();
            const years = [...new Set(danhsachchi.map(item => new Date(item["Ngày giải ngân"]).getFullYear()))].sort();

            // Generate filter checkboxes
            generateCheckboxes('khuVucFilter', khuVucs, 'khuVuc');
            generateCheckboxes('duAnFilter', duAns, 'duAn');
            generateCheckboxes('maChiFilter', maChis, 'maChi');
            generateCheckboxes('nhanVienFilter', nhanViens, 'nhanVien');
            generateCheckboxes('trangThaiFilter', trangThais, 'trangThai');
            // Initialize year filters
            const yearFilter = document.getElementById('yearFilter');
            const quarterYearFilter = document.getElementById('quarterYearFilter');
            const yearOptions = years.map(year =>
                `<option value="${year}">${year}</option>`
            ).join('');
            yearFilter.innerHTML = yearOptions;
            quarterYearFilter.innerHTML = yearOptions;

            // Initialize time filter handlers
            initializeTimeFilters();
            initializeSearchFilters();
        };

        const generateCheckboxes = (containerId, items, name) => {
        const container = document.getElementById(containerId);
        container.innerHTML = items.map(item => `
            <div class="checkbox-container p-2 rounded-md">
                <label class="flex items-center space-x-2 cursor-pointer w-full">
                    <input type="checkbox" name="${name}" value="${item}" 
                           class="form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out"
                           onchange="updateCheckboxStyles()">
                    <span class="text-sm text-gray-700 dark:text-gray-300 flex-grow">${item}</span>
                </label>
            </div>
        `).join('');
    };

        // Event handlers
        const initializeEventHandlers = () => {
            // Time filter change
            document.getElementById('timeFilterType').addEventListener('change', function () {
                document.getElementById('customDateRange').classList.add('hidden');
                document.getElementById('weekSelector').classList.add('hidden');
                document.getElementById('monthSelector').classList.add('hidden');
                document.getElementById('yearSelector').classList.add('hidden');
                document.getElementById('quarterSelector').classList.add('hidden');

                document.getElementById(this.value + 'Selector')?.classList.remove('hidden');
                if (this.value === 'custom') {
                    document.getElementById('customDateRange').classList.remove('hidden');
                }
            });

            // Table sorting
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.dataset.sort;
                    if (sortColumn === column) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = column;
                        sortDirection = 'asc';
                    }
                    updateUI();
                });
            });

            // Pagination
            document.getElementById('prevPage').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updateUI();
                }
            });

            document.getElementById('nextPage').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredData.length / pageSize);
                if (currentPage < totalPages) {
                    currentPage++;
                    updateUI();
                }
            });

            document.getElementById('pageNumbers').addEventListener('click', (e) => {
                const page = e.target.dataset.page;
                if (page) {
                    currentPage = parseInt(page);
                    updateUI();
                }
            });

            // Page size change
            document.getElementById('pageSize').addEventListener('change', (e) => {
                pageSize = parseInt(e.target.value);
                currentPage = 1;
                updateUI();
            });

            // Search
            document.getElementById('tableSearch').addEventListener('input', debounce(() => {
                currentPage = 1;
                updateUI();
            }, 300));

            // Filter buttons
            document.getElementById('applyFilters').addEventListener('click', () => {
                currentPage = 1;
                updateUI();
            });

            document.getElementById('resetFilters').addEventListener('click', () => {
                // Reset all filters
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                document.getElementById('timeFilterType').value = 'custom';
                document.getElementById('fromDate').value = '';
                document.getElementById('toDate').value = '';
                document.getElementById('weekFilter').value = '';
                document.getElementById('monthFilter').value = '';
                document.getElementById('yearFilter').value = '';
                document.getElementById('quarterFilter').value = '1';
                document.getElementById('tableSearch').value = '';

                // Reset to default view
                currentPage = 1;
                sortColumn = 'Ngày giải ngân';
                sortDirection = 'desc';
                updateUI();
            });

            // Mobile menu toggle
            document.getElementById('toggleFilters').addEventListener('click', () => {
                const sidebar = document.getElementById('filtersSidebar');
                const overlay = document.getElementById('overlay');
                sidebar.classList.toggle('-translate-x-full');
                overlay.classList.toggle('hidden');
            });

            // Export Excel
            document.getElementById('exportExcel').addEventListener('click', () => {
                exportToExcel(filteredData);
            });
        };

        // Export function
        const exportToExcel = (data) => {
            const exportData = data.map(item => ({
                'Ngày giải ngân': formatDate(item["Ngày giải ngân"]),
                'Thời gian': formatDate(item["Thời gian"]),
                'Khu vực': item["KHU VỰC"],
                'Dự án': item["Dự án"],
                'Mã CHI': item["Mã CHI"],
                'Số tiền': parseFloat(item["SỐ TIỀN"]),
                'Nhân viên': item["NHÂN VIÊN THỰC HIỆN"],
                'Nội dung': item["NỘI DUNG"],
                'Trạng thái': item["TRẠNG THÁI"]
            }));

            // Add summary row
            const totalAmount = data.reduce((sum, item) => sum + parseFloat(item["SỐ TIỀN"]), 0);
            exportData.push({
                'Ngày giải ngân': 'TỔNG CỘNG',
                'Thời gian': '',
                'Khu vực': '',
                'Dự án': '',
                'Mã CHI': '',
                'Số tiền': totalAmount,
                'Nhân viên': '',
                'Nội dung': '',
                'Trạng thái': ''
            });

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();

            // Set column widths
            const colWidths = [
                { wch: 20 }, // Ngày giải ngân
                { wch: 10 }, // Khu vực
                { wch: 15 }, // Dự án
                { wch: 10 }, // Mã CHI
                { wch: 15 }, // Số tiền
                { wch: 20 }, // Nhân viên
                { wch: 50 }, // Nội dung
                { wch: 15 }  // Trạng thái
            ];
            ws['!cols'] = colWidths;

            XLSX.utils.book_append_sheet(wb, ws, "Chi phí");
            XLSX.writeFile(wb, `Bao_cao_chi_phi_${new Date().toLocaleDateString('vi-VN').replace(/\//g, '_')}.xlsx`);
        };

        // Utility functions
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };



        // Search filter initialization and handling
        const initializeSearchFilters = () => {
            const searchInputs = {
                khuVuc: document.getElementById('khuVucSearch'),
                duAn: document.getElementById('duAnSearch'),
                maChi: document.getElementById('maChiSearch'),
                nhanVien: document.getElementById('nhanVienSearch'),
                trangThai: document.getElementById('trangThaiSearch') // Add this line
            };

            Object.entries(searchInputs).forEach(([key, input]) => {
                input.addEventListener('input', debounce(function () {
                    const searchTerm = this.value.toLowerCase();
                    const container = document.getElementById(`${key}Filter`);
                    const checkboxes = container.querySelectorAll('.checkbox-container');

                    checkboxes.forEach(checkbox => {
                        const label = checkbox.querySelector('span').textContent.toLowerCase();
                        if (label.includes(searchTerm)) {
                            checkbox.classList.remove('hidden');
                        } else {
                            checkbox.classList.add('hidden');
                        }
                    });
                }, 300));
            });
        };

        const initializeTimeFilters = () => {
            const today = new Date();

            // Set default dates for custom range
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('fromDate').valueAsDate = firstDayOfMonth;
            document.getElementById('toDate').valueAsDate = today;

            // Set current week
            const currentWeek = getCurrentWeekNumber();
            const weekInput = document.getElementById('weekFilter');
            weekInput.value = `${today.getFullYear()}-W${currentWeek.toString().padStart(2, '0')}`;

            // Set current month
            const monthInput = document.getElementById('monthFilter');
            monthInput.value = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}`;

            // Set current quarter
            const currentQuarter = Math.floor(today.getMonth() / 3) + 1;
            document.getElementById('quarterFilter').value = currentQuarter;
            document.getElementById('quarterYearFilter').value = today.getFullYear();

            // Add week filter change handler
            weekInput.addEventListener('change', () => {
                if (weekInput.value) {
                    const [year, weekNum] = weekInput.value.split('-W');
                    const weekRange = getWeekRange(parseInt(weekNum), parseInt(year));
                    const dateRangeDisplay = document.getElementById('dateRange');
                    if (dateRangeDisplay) {
                        dateRangeDisplay.textContent = formatDateRange(weekRange.start, weekRange.end);
                    }
                }
            });
        };

        // Helper function to get week number
        const getWeekNumber = (date) => {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        };

        // Update the select all functionality
    const initializeSelectAllCheckboxes = () => {
        const filterGroups = ['khuVuc', 'duAn', 'maChi', 'nhanVien', 'trangThai'];

        filterGroups.forEach(group => {
            const container = document.getElementById(`${group}Filter`);
            const checkboxes = container.querySelectorAll('input[type="checkbox"]');

            // Create select all checkbox with highlight style
            const selectAllDiv = document.createElement('div');
            selectAllDiv.className = 'checkbox-container mb-2 border-b border-gray-200 dark:border-gray-700 pb-2';
            selectAllDiv.innerHTML = `
                <label class="flex items-center space-x-2 cursor-pointer p-2">
                    <input type="checkbox" id="selectAll${group}" 
                           class="form-checkbox h-4 w-4 text-indigo-600 transition duration-150 ease-in-out">
                    <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Chọn tất cả</span>
                </label>
            `;
            container.insertBefore(selectAllDiv, container.firstChild);

            // Add event listener for select all
            const selectAllCheckbox = document.getElementById(`selectAll${group}`);
            selectAllCheckbox.addEventListener('change', () => {
                checkboxes.forEach(cb => {
                    if (!cb.closest('.checkbox-container').classList.contains('hidden')) {
                        cb.checked = selectAllCheckbox.checked;
                    }
                });
                updateCheckboxStyles();
                updateFilterCounts();
                updateUI();
            });

            // Update select all state when individual checkboxes change
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    const visibleCheckboxes = Array.from(checkboxes).filter(
                        cb => !cb.closest('.checkbox-container').classList.contains('hidden')
                    );
                    const allChecked = visibleCheckboxes.every(cb => cb.checked);
                    const someChecked = visibleCheckboxes.some(cb => cb.checked);

                    selectAllCheckbox.checked = allChecked;
                    selectAllCheckbox.indeterminate = someChecked && !allChecked;

                    updateFilterCount();
                    updateUI();
                });
            });
        });
    };
    // Function to get selected items count for display
    const updateSelectedItemsCount = (groupId) => {
        const container = document.getElementById(`${groupId}Filter`);
        const checkedCount = container.querySelectorAll('input[type="checkbox"]:checked').length;
        const countDisplay = document.getElementById(`selected${groupId.charAt(0).toUpperCase() + groupId.slice(1)}Count`);
        if (countDisplay) {
            countDisplay.textContent = `${checkedCount} đã chọn`;
            // Add highlight to the count badge if items are selected
            countDisplay.classList.toggle('bg-indigo-500', checkedCount > 0);
            countDisplay.classList.toggle('text-white', checkedCount > 0);
        }
    };

    // Update all counts when filters change
    const updateAllSelectedCounts = () => {
        ['khuVuc', 'duAn', 'maChi', 'nhanVien', 'trangThai'].forEach(group => {
            updateSelectedItemsCount(group);
        });
    };
        // Statistics chart initialization
        const initializeCharts = () => {
            // Create charts container if it doesn't exist
            const mainContent = document.querySelector('main .max-w-9xl');
            const chartsContainer = document.createElement('div');
            chartsContainer.className = 'grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6';
            chartsContainer.id = 'chartsContainer';

            // Add chart divs
            chartsContainer.innerHTML = `
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Chi phí theo khu vực</h3>
            <div id="areaChart" class="h-80"></div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Chi phí theo loại</h3>
            <div id="expenseTypeChart" class="h-80"></div>
        </div>
    `;

            mainContent.appendChild(chartsContainer);

            // Initialize charts (using Highcharts)
            updateCharts(filteredData);
        };

        const updateCharts = (data) => {
            // Prepare data for charts
            const areaData = Object.entries(calculateStats(data, "KHU VỰC"))
                .map(([area, stats]) => ({
                    name: area,
                    y: stats.amount
                }))
                .sort((a, b) => b.y - a.y);

            const expenseTypeData = Object.entries(calculateStats(data, "Mã CHI"))
                .map(([type, stats]) => ({
                    name: type,
                    y: stats.amount
                }))
                .sort((a, b) => b.y - a.y);

            // Create/update area chart
            Highcharts.chart('areaChart', {
                chart: {
                    type: 'pie',
                    backgroundColor: 'transparent'
                },
                title: null,
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b><br>Giá trị: <b>{point.y:,.0f} VND</b>'
                },
                accessibility: {
                    announceNewData: {
                        enabled: true
                    },
                    point: {
                        valueSuffix: '%'
                    }
                },
                plotOptions: {
                    pie: {
                        allowPointSelect: true,
                        cursor: 'pointer',
                        dataLabels: {
                            enabled: true,
                            format: '<b>{point.name}</b>: {point.percentage:.1f} %'
                        }
                    }
                },
                series: [{
                    name: 'Tỷ lệ',
                    colorByPoint: true,
                    data: areaData
                }]
            });

            // Create/update expense type chart
            Highcharts.chart('expenseTypeChart', {
                chart: {
                    type: 'column'

                },
                title: null,
                xAxis: {
                    type: 'category',
                    labels: {
                        rotation: -45,
                        style: {
                            fontSize: '13px'
                        }
                    }
                },
                yAxis: {
                    title: {
                        text: 'Giá trị (VND)'
                    }
                },
                legend: {
                    enabled: false
                },
                tooltip: {
                    pointFormat: 'Giá trị: <b>{point.y:,.0f} VND</b>'
                },
                series: [{
                    name: 'Chi phí',
                    data: expenseTypeData,
                    dataLabels: {
                        enabled: true,
                        rotation: -90,
                        color: '#1A1A1D',
                        align: 'right',
                        format: '{point.y:,.0f}',
                        y: 10
                    }
                }]
            });
        };

        // Apply button loading state
        const setLoadingState = (button, loading) => {
            if (loading) {
                button.disabled = true;
                button.innerHTML = `
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Đang xử lý...
        `;
            } else {
                button.disabled = false;
                button.innerHTML = `
            <i class="fas fa-filter"></i>
            <span>Áp dụng</span>
        `;
            }
        };
          // Add event listeners for checkbox changes
    document.addEventListener('DOMContentLoaded', () => {
        const filterGroups = ['khuVuc', 'duAn', 'maChi', 'nhanVien', 'trangThai'];
        
        filterGroups.forEach(group => {
            const container = document.getElementById(`${group}Filter`);
            if (container) {
                container.addEventListener('change', (e) => {
                    if (e.target.type === 'checkbox') {
                        updateCheckboxStyles();
                    }
                });
            }
        });
    });

        // Initialize application
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                document.getElementById('loading').classList.remove('hidden');

                await init(); // Khởi tạo dữ liệu từ API

                initializeFilters();
                initializeEventHandlers();
                initializeSelectAllCheckboxes();
                initializeCharts();

                updateUI();

            } catch (error) {
                console.error('Error initializing dashboard:', error);
                alert('Có lỗi xảy ra khi khởi tạo ứng dụng. Vui lòng thử lại.');
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        });
    </script>
</body>

</html>
