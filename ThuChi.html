<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form Ghi Chi Phí</title>
    
    <link rel="shortcut icon" href="Logo N có bóng/Logo N.png" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/luxon/3.4.4/luxon.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <!-- Thêm Toastify CSS và JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        .fixed-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 600px;
            z-index: 1000;
        }

        .form-container {
            padding-bottom: 80px;
            /* Add space for the fixed button */
        }
    </style>
</head>

<body class="bg-gray-100 p-6">
    <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl p-6">
        <h2 class="text-2xl font-bold mb-4">Ghi nhận Chi Phí NZ</h2>
        <form id="expenseForm" class="space-y-4">
            <input type="hidden" id="id_chi" name="id_chi">

            <div>
                <label for="ngay_chi" class="block text-sm font-medium text-gray-700">Ngày chi</label>
                <input type="date" id="ngay_chi" name="ngay_chi"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                    required>
            </div>

            <div>
                <label for="loai_chi_phi" class="block text-sm font-medium text-gray-700">Loại Chi phí</label>
                <select id="loai_chi_phi" name="loai_chi_phi"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                    required>
                    <option value="">Chọn loại chi phí</option>
                    <option value="Chi phí phát sinh">Chi phí phát sinh</option>
                    <option value="Điện lực">Điện lực</option>
                    <option value="Nước Uống, cafe">Nước Uống, cafe</option>
                    <option value="Mua ty kẹp">Mua ty kẹp</option>
                    <option value="Chuyển hồ sơ">Chuyển hồ sơ</option>
                    <option value="Điện, Dịch Vụ Tòa Nhà">Điện, Dịch Vụ Tòa Nhà</option>
                    <option value="Đường Điện Thoại">Đường Điện Thoại</option>
                    <option value="In Ấn Công Chứng">In Ấn Công Chứng</option>
                    <option value="Internet">Internet</option>
                    <option value="Thi Công Vp">Thi Công Vp</option>
                    <option value="Thuê Văn Phòng">Thuê Văn Phòng</option>
                    <option value="Văn Phòng Phẩm">Văn Phòng Phẩm</option>
                    <option value="Giải chi Chi phí">Giải chi Chi phí</option>
                    <option value="Giải chi Ứng Lương">Giải chi Ứng Lương</option>
                    <option value="Thuê xe">Thuê xe</option>
                    <option value="Mua vật tư">Mua vật tư</option>
                    <option value="Công Tác Phí">Công Tác Phí</option>
                    <option value="Khách Sạn">Khách Sạn</option>
                    <option value="Vé Máy Bay">Vé Máy Bay</option>
                    <option value="Visa">Visa</option>
                    <option value="Phí Khác">Phí Khác</option>
                    <option value="Chi Phí Đi Lại">Chi Phí Đi Lại</option>
                    <option value="Dịch Vụ Khác">Dịch Vụ Khác</option>
                    <option value="Phí Nộp, Chuyển Tiền">Phí Nộp, Chuyển Tiền</option>
                    <option value="Phí Cloud, Server, License">Phí Cloud, Server, License</option>
                    <option value="Sửa Chữa, Bảo Hành">Sửa Chữa, Bảo Hành</option>
                    <option value="Du Lịch">Du Lịch</option>
                    <option value="Sinh Nhật Công Ty">Sinh Nhật Công Ty</option>
                    <option value="Hoạt Động Khác">Hoạt Động Khác</option>
                    <option value="Tất niên">Tất niên</option>
                    <option value="Lương">Lương</option>
                    <option value="Bảo Hiểm">Bảo Hiểm</option>
                    <option value="Hỗ Trợ Đào Tạo">Hỗ Trợ Đào Tạo</option>
                    <option value="Khám Sức Khỏe">Khám Sức Khỏe</option>
                    <option value="Sinh Nhật">Sinh Nhật</option>
                    <option value="Thưởng Khác">Thưởng Khác</option>
                    <option value="Phân Bổ CCDC">Phân Bổ CCDC</option>
                    <option value="Trang Thiết Bị VP">Trang Thiết Bị VP</option>
                    <option value="Thiết Bị Khác">Thiết Bị Khác</option>
                    <option value="Đăng Tuyển">Đăng Tuyển</option>
                    <option value="Giới Thiệu Nhân Sự">Giới Thiệu Nhân Sự</option>
                    <option value="Chi phí khác">Chi phí khác</option>
                    <option value="Chi phí sinh hoạt">Chi phí sinh hoạt</option>
                    <option value="Thuê xe vận chuyển giao máy hàn Hiển Sửa">Thuê xe vận chuyển giao máy hàn Hiển Sửa
                    </option>
                    <option value="Mua hàng">Mua hàng</option>
                    <option value="Vận chuyển">Vận chuyển</option>
                    <option value="Ăn Uống">Ăn Uống</option>
                    <option value="Xăng, Dầu">Xăng, Dầu</option>
                    <option value="Tiếp khách">Tiếp khách</option>
                    <option value="Thi Công">Thi Công</option>
                    <option value="Hỗ Trợ chi phí thi công">Hỗ Trợ chi phí thi công</option>
                </select>
            </div>

            <div>
                <label for="noi_dung" class="block text-sm font-medium text-gray-700">Nội dung</label>
                <input type="text" id="noi_dung" name="noi_dung"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                    required>
            </div>

            <div>
                <label for="nhan_vien" class="block text-sm font-medium text-gray-700">Nhân viên</label>
                <input type="text" id="nhan_vien" name="nhan_vien"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                    readonly>
            </div>

            <div>
                <label for="so_tien" class="block text-sm font-medium text-gray-700">Số tiền</label>
                <div class="relative mt-1 rounded-md shadow-sm">
                    <input type="text" id="so_tien" name="so_tien"
                        class="block w-full rounded-md border-gray-300 pl-3 pr-12 focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                        placeholder="0" required>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                        <span class="text-gray-500 sm:text-sm">VND</span>
                    </div>
                </div>
            </div>

            <div>
                <label for="so_tien_chu" class="block text-sm font-medium text-gray-700">Số tiền bằng chữ</label>
                <input type="text" id="so_tien_chu" name="so_tien_chu"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                    readonly>
            </div>
            <div>
                <label for="hinh_anh" class="block text-sm font-medium text-gray-700">Hình ảnh</label>
                <input type="file" id="hinh_anh" name="hinh_anh" accept="image/*"
                    class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                <div id="image_preview" class="mt-2"></div>
            </div>

            <div>
                <label for="ghi_chu" class="block text-sm font-medium text-gray-700">Ghi chú</label>
                <textarea id="ghi_chu" name="ghi_chu" rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>

            <div>
                <label for="doi_tuong" class="block text-sm font-medium text-gray-700">Đối tượng</label>
                <input type="text" id="doi_tuong" name="doi_tuong"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>

            <div>
                <label for="khach_hang" class="block text-sm font-medium text-gray-700">Khách hàng</label>
                <input type="text" id="khach_hang" name="khach_hang"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>

            <div>
                <label for="mda" class="block text-sm font-medium text-gray-700">MDA</label>
                <input type="text" id="mda" name="mda"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>

            <div class="fixed-button">
                <button type="submit" form="expenseForm"
                    class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Gửi
                </button>
            </div>
        </form>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        // Constants for AppSheet API
        const appId = '3429512c-79d0-44f0-8197-e6a77f2bb498';
        const accessKey = 'V2-CmjiU-ViCzw-1xjZc-QAlWm-zNnZ4-eTiEz-lODjW-fqJmt';
        const region = 'www';
        function apiRequest(tableName, action, data) {
            const apiUrl = `https://${region}.appsheet.com/api/v2/apps/${appId}/tables/${tableName}/Action`;
            return $.ajax({
                url: apiUrl,
                method: 'POST',
                headers: {
                    'ApplicationAccessKey': accessKey,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    Action: action,
                    Properties: {
                        Locale: 'vi-VN',
                        Timezone: 'Asia/Ho_Chi_Minh'
                    },
                    ...data
                })
            }).then(response => {
                return response;
            }).catch(error => {

                throw error;
            });
        }

        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);

            });
        }


        document.addEventListener('DOMContentLoaded', function () {
            // Tạo ID_CHI (ẩn)
            const idChiInput = document.getElementById('id_chi');
            idChiInput.value = `EXP-${Date.now()}`;

            // Đặt ngày hiện tại cho trường ngày chi
            const ngayChiInput = document.getElementById('ngay_chi');
            ngayChiInput.value = luxon.DateTime.now().toFormat('yyyy-MM-dd');

            // Lấy tên nhân viên từ URL
            const urlParams = new URLSearchParams(window.location.search);
            const manv = urlParams.get('manv');
            if (manv) {
                document.getElementById('nhan_vien').value = manv;
            }

            // Khởi tạo Choices.js cho select loại chi phí
            const loaiChiPhiSelect = new Choices('#loai_chi_phi', {
                searchEnabled: true,
                searchPlaceholderValue: "Tìm kiếm loại chi phí",
                noResultsText: 'Không tìm thấy kết quả',
                itemSelectText: 'Nhấn để chọn',
                classNames: {
                    containerOuter: 'choices',
                    containerInner: 'choices__inner',
                    input: 'choices__input',
                    inputCloned: 'choices__input--cloned',
                    list: 'choices__list',
                    listItems: 'choices__list--multiple',
                    listSingle: 'choices__list--single',
                    listDropdown: 'choices__list--dropdown',
                    item: 'choices__item',
                    itemSelectable: 'choices__item--selectable',
                    itemDisabled: 'choices__item--disabled',
                    itemChoice: 'choices__item--choice',
                    placeholder: 'choices__placeholder',
                    group: 'choices__group',
                    groupHeading: 'choices__heading',
                    button: 'choices__button',
                    activeState: 'is-active',
                    focusState: 'is-focused',
                    openState: 'is-open',
                    disabledState: 'is-disabled',
                    highlightedState: 'is-highlighted',
                    selectedState: 'is-selected',
                    flippedState: 'is-flipped',
                    loadingState: 'is-loading',
                    noResults: 'has-no-results',
                    noChoices: 'has-no-choices'
                },
            });

            // Xử lý số tiền và chuyển đổi sang chữ
            const soTienInput = document.getElementById('so_tien');
            const soTienChuInput = document.getElementById('so_tien_chu');

            soTienInput.addEventListener('input', function (e) {
                // Lấy giá trị hiện tại của input
                let value = e.target.value;

                // Loại bỏ tất cả các ký tự không phải số
                value = value.replace(/[^\d]/g, '');

                // Chuyển đổi sang số
                let numericValue = parseInt(value, 10);

                if (isNaN(numericValue)) {
                    // Nếu không phải số hợp lệ, đặt giá trị trống
                    e.target.value = '';
                    soTienChuInput.value = '';
                } else {
                    // Định dạng số với dấu phẩy ngăn cách hàng nghìn
                    let formattedValue = numericValue.toLocaleString('en-US');

                    // Cập nhật giá trị của input
                    e.target.value = formattedValue;

                    // Cập nhật số tiền bằng chữ
                    soTienChuInput.value = numberToWords(numericValue) + ' đồng';
                }
            });

            // Xử lý preview hình ảnh
            const hinhAnhInput = document.getElementById('hinh_anh');
            const imagePreview = document.getElementById('image_preview');
            hinhAnhInput.addEventListener('change', function (e) {
                imagePreview.innerHTML = '';
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'h-20 w-20 object-cover rounded-md';
                        imagePreview.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                }
            });

            // Cập nhật xử lý gửi form
            document.getElementById('expenseForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                // Kiểm tra các trường bắt buộc
                const requiredFields = ['ngay_chi', 'loai_chi_phi', 'noi_dung', 'so_tien'];
                const missingFields = [];

                requiredFields.forEach(field => {
                    const input = this.elements[field];
                    if (!input.value.trim()) {
                        missingFields.push(input.previousElementSibling.textContent);
                    }
                });

                if (missingFields.length > 0) {
                    // Hiển thị thông báo lỗi nếu thiếu thông tin
                    Toastify({
                        text: `Vui lòng nhập đầy đủ thông tin: ${missingFields.join(', ')}`,
                        duration: 4000,
                        close: true,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                    }).showToast();
                    return;
                }
              
                // Thu thập dữ liệu form
                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());

                // Xử lý số tiền (loại bỏ dấu phẩy)
                data.so_tien = data.so_tien.replace(/,/g, '');


                const fileInput = document.getElementById('hinh_anh');
                let filebase = "";
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    filebase = await readFile(file);
                }
                // Log dữ liệu ra console
                console.log('Form Data:', data);
                const thuChiData = {
                    "Ngày chi": data.ngay_chi,
                    "Loại Chi phí": data.loai_chi_phi,
                    "Nội dung": data.noi_dung,
                    "Nhân viên": data.nhan_vien,
                    "Số tiền": data.so_tien,
                    "Hình ảnh 1": filebase,
                    "Ghi chú": data.ghi_chu,
                    "Lịch sử": data.nhan_vien + ' đã tạo phiếu vào ngày ' + data.ngay_chi + "(Phiếu được tạo bằng api)",
                    "Đối tượng": data.doi_tuong,
                    "Khách hàng": data.khach_hang

                };

                console.log(thuChiData);
                disableForm();
                showLoadingOverlay();
                const duAnResponse = await apiRequest('Chi phí', 'Add', {
                    Rows: [thuChiData]
                });
             



                // Hiển thị thông báo thành công
                Toastify({
                    text: "Form đã được gửi thành công!",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                }).showToast();
                // Reset form (giữ lại trường nhân viên)
                const nhanVienValue = this.elements['nhan_vien'].value;
                this.reset();
                this.elements['nhan_vien'].value = nhanVienValue;
                // Reset các trường khác
                document.getElementById('image_preview').innerHTML = '';
                document.getElementById('so_tien_chu').value = '';

              
                enableForm();
                hideLoadingOverlay();
            });
        });
        // Hàm để disable form
        function disableForm() {
            const form = document.getElementById('expenseForm');
            const elements = form.elements;
            for (let i = 0; i < elements.length; i++) {
                elements[i].disabled = true;
            }
        }

        // Hàm để enable form
        function enableForm() {
            const form = document.getElementById('expenseForm');
            const elements = form.elements;
            for (let i = 0; i < elements.length; i++) {
                elements[i].disabled = false;
            }
        }

        // Hàm để hiển thị loading overlay
        function showLoadingOverlay() {
            const overlay = document.createElement('div');
            overlay.id = 'loadingOverlay';
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.zIndex = '9999';

            const spinner = document.createElement('div');
            spinner.style.border = '4px solid #f3f3f3';
            spinner.style.borderTop = '4px solid #3498db';
            spinner.style.borderRadius = '50%';
            spinner.style.width = '50px';
            spinner.style.height = '50px';
            spinner.style.animation = 'spin 1s linear infinite';

            const keyframes = document.createElement('style');
            keyframes.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;

            document.head.appendChild(keyframes);
            overlay.appendChild(spinner);
            document.body.appendChild(overlay);
        }

        // Hàm để ẩn loading overlay
        function hideLoadingOverlay() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }
        // Hàm chuyển đổi số thành chữ
        function numberToWords(number) {
            const units = ['', 'một', 'hai', 'ba', 'bốn', 'năm', 'sáu', 'bảy', 'tám', 'chín'];
            const teens = ['mười', 'mười một', 'mười hai', 'mười ba', 'mười bốn', 'mười lăm', 'mười sáu', 'mười bảy', 'mười tám', 'mười chín'];
            const tens = ['', '', 'hai mươi', 'ba mươi', 'bốn mươi', 'năm mươi', 'sáu mươi', 'bảy mươi', 'tám mươi', 'chín mươi'];
            const scales = ['', 'nghìn', 'triệu', 'tỷ', 'nghìn tỷ', 'triệu tỷ'];

            if (number === 0) return 'không';

            const numString = number.toString();
            const parts = [];

            for (let i = numString.length; i > 0; i -= 3) {
                parts.unshift(numString.slice(Math.max(0, i - 3), i));
            }

            function convertGroup(n) {
                let result = '';
                if (n[0] !== '0') {
                    result += units[n[0]] + ' trăm ';
                    if (n[1] === '0' && n[2] !== '0') result += 'lẻ ';
                }
                if (n[1] === '1') {
                    result += teens[parseInt(n[2])];
                } else {
                    if (n[1] !== '0') result += tens[n[1]] + ' ';
                    if (n[2] !== '0') result += units[n[2]];
                }
                return result.trim();
            }

            return parts.map((part, i) => {
                if (parseInt(part) !== 0) {
                    return convertGroup(part.padStart(3, '0')) + (scales[parts.length - 1 - i] ? ' ' + scales[parts.length - 1 - i] : '');
                }
                return '';
            }).filter(Boolean).join(' ');
        }
    </script>
</body>

</html>